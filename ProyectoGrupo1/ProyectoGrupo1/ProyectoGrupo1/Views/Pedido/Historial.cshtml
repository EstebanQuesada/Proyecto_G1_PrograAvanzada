@model ProyectoGrupo1.Models.HistorialPedidoViewModel
@{
    ViewData["Title"] = "Historial de Pedidos";

    string EstadoBadge(string e) => (e ?? "").ToLower() switch
    {
        "completado" => "bg-success",
        "enviado" => "bg-info",
        "cancelado" => "bg-danger",
        "procesando" => "bg-warning text-dark",
        _ => "bg-secondary"
    };
}

<div class="page-header mb-3">
    <h2 class="page-title">@ViewData["Title"]</h2>
    <a asp-controller="Producto" asp-action="Catalogo" class="btn btn-ghost">Ir al catálogo</a>
</div>

@if (TempData["Mensaje"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mb-3" role="alert">
        @TempData["Mensaje"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
    </div>
}

@if (Model?.Pedidos == null || !Model.Pedidos.Any())
{
    <div class="empty-state">
        No tienes pedidos registrados aún.
        <div class="mt-2">
            <a asp-controller="Producto" asp-action="Catalogo" class="btn btn-main">Ir al catálogo</a>
        </div>
    </div>
}
else
{
    foreach (var pedido in Model.Pedidos)
    {
        var totalPedido = pedido.Detalles.Sum(d => d.PrecioUnitario * d.Cantidad);
        <div class="card-elevated mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Pedido #@pedido.PedidoID</strong> · @pedido.FechaPedido.ToString("dd/MM/yyyy")
                    <span class="badge rounded-pill @EstadoBadge(pedido.NombreEstado) ms-2">@pedido.NombreEstado</span>
                </div>
                <div class="fw-semibold">Total: @totalPedido.ToString("C")</div>
            </div>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-modern align-middle">
                        <thead>
                            <tr>
                                <th style="width:72px">Img</th>
                                <th>Producto</th>
                                <th style="width:160px">Variante</th>
                                <th class="text-end" style="width:100px">Cant.</th>
                                <th class="text-end" style="width:140px">P. Unit</th>
                                <th class="text-end" style="width:160px">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var d in pedido.Detalles)
                            {
                                var subtotal = d.PrecioUnitario * d.Cantidad;
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrWhiteSpace(d.UrlImagen))
                                        {
                                            <img src="@d.UrlImagen" alt="@d.Producto"
                                                 style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #e5e7eb" />
                                        }
                                    </td>
                                    <td class="fw-semibold">@d.Producto</td>
                                    <td>@d.NombreTalla / @d.NombreColor</td>
                                    <td class="text-end">@d.Cantidad</td>
                                    <td class="text-end">@d.PrecioUnitario.ToString("C")</td>
                                    <td class="text-end">@subtotal.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <form asp-action="VolverAPedir" method="post" class="mt-2">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="pedidoId" value="@pedido.PedidoID" />
                    <button type="submit" class="btn btn-outline-primary">Volver a pedir</button>
                </form>
            </div>
        </div>
    }
}

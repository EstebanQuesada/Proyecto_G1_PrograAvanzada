@model ApiAdminUsuarioClient.PagedResult<ApiAdminUsuarioClient.AdminUserListItemDto>
@{
    ViewData["Title"] = "Administración de usuarios";

    var q = ViewContext.HttpContext.Request.Query["q"].ToString();
    int pageIndex = 1, pageSize = 10;
    int.TryParse(ViewContext.HttpContext.Request.Query["page"], out pageIndex);
    int.TryParse(ViewContext.HttpContext.Request.Query["pageSize"], out pageSize);

    var hasItems = Model?.Items != null && Model.Items.Any();
    var totalPages = hasItems ? (int)Math.Ceiling(Model!.Total / (double)pageSize) : 1;
}

@if (TempData["Msg"] is string msg)
{
    <div class="alert alert-warning mb-3">@msg</div>
}

<div class="page-header mb-3">
    <h2 class="page-title">Usuarios</h2>
    <a asp-action="Crear" class="btn btn-main">Nuevo usuario</a>
</div>

<div class="card-elevated mb-3">
    <div class="card-body">
        <form method="get" class="toolbar" autocomplete="off">
            <input type="text" class="form-control" name="q" value="@q" placeholder="Buscar nombre/correo" />
            <input type="hidden" name="pageSize" value="@pageSize" />
            <button class="btn btn-primary">Buscar</button>
            <a asp-action="Index" class="btn btn-ghost">Limpiar</a>
        </form>
    </div>
</div>

<div class="table-wrap">
    <div class="table-responsive">
        <table class="table table-modern table-hover align-middle">
            <thead>
                <tr>
                    <th style="width:80px">ID</th>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th style="width:120px">Rol</th>
                    <th style="width:160px">Estado</th>
                    <th class="text-end" style="width:360px">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (hasItems)
                {
                    foreach (var u in Model!.Items)
                    {
                        var rolBadge = u.RolID == 2 ? "bg-dark text-white" : "bg-info";
                        var rolText = u.RolID == 2 ? "Admin" : "Cliente";
                        <tr>
                            <td class="text-muted">@u.UsuarioID</td>
                            <td>@u.Nombre @u.Apellido</td>
                            <td><a href="mailto:@u.Correo">@u.Correo</a></td>
                            <td><span class="badge rounded-pill @rolBadge">@rolText</span></td>
                            <td>
                                <span class="badge rounded-pill @(u.Activo ? "bg-success" : "bg-secondary") me-2">
                                    @(u.Activo ? "Activo" : "Inactivo")
                                </span>
                                @if (u.Bloqueado)
                                {
                                    <span class="badge rounded-pill bg-warning text-dark">Bloqueado</span>
                                }
                            </td>
                            <td class="text-end text-nowrap">
                                <a asp-action="Editar" asp-route-id="@u.UsuarioID" class="btn btn-sm btn-outline-primary">Editar</a>

                                <form asp-action="Bloquear" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@u.UsuarioID" />
                                    <input type="hidden" name="bloqueado" value="@(u.Bloqueado ? "false" : "true")" />
                                    <button class="btn btn-sm btn-warning">@(u.Bloqueado ? "Desbloquear" : "Bloquear")</button>
                                </form>

                                <form asp-action="Eliminar" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@u.UsuarioID" />
                                    <button class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('¿Eliminar (soft) este usuario?');">
                                        Eliminar
                                    </button>
                                </form>

                                <form asp-action="Restaurar" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@u.UsuarioID" />
                                    <button class="btn btn-sm btn-success">Restaurar</button>
                                </form>

                                <form asp-action="CambiarRol" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@u.UsuarioID" />
                                    <input type="hidden" name="rolId" value="@(u.RolID == 1 ? 2 : 1)" />
                                    <button class="btn btn-sm btn-info">@(u.RolID == 1 ? "Hacer Admin" : "Hacer Cliente")</button>
                                </form>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr><td colspan="6" class="empty-state">No hay usuarios para mostrar.</td></tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (hasItems)
{
    <nav class="mt-3" aria-label="Paginación">
        <ul class="pagination justify-content-end mb-0">
            <li class="page-item @(pageIndex <= 1 ? "disabled" : "")">
                <a class="page-link" asp-action="Index"
                   asp-route-page="@(pageIndex - 1)" asp-route-pageSize="@pageSize" asp-route-q="@q">Anterior</a>
            </li>
            <li class="page-item disabled"><span class="page-link">Página @(pageIndex) de @totalPages</span></li>
            <li class="page-item @(pageIndex >= totalPages ? "disabled" : "")">
                <a class="page-link" asp-action="Index"
                   asp-route-page="@(pageIndex + 1)" asp-route-pageSize="@pageSize" asp-route-q="@q">Siguiente</a>
            </li>
        </ul>
    </nav>
}

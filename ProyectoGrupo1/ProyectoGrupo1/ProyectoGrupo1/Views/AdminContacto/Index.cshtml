@* Proyecto: ProyectoGrupo1 (MVC)
   Archivo: Views/AdminContacto/Index.cshtml *@
@model List<ProyectoGrupo1.Services.AdminContactoItemVm>
@{
    ViewData["Title"] = "Mensajes de Contacto";
    var buscar = (string?)ViewBag.Buscar ?? "";
    var estado = (string?)ViewBag.Estado ?? "";
    var page = (int)(ViewBag.Page ?? 1);
    var pageSize = (int)(ViewBag.PageSize ?? 20);
    var total = (int)(ViewBag.Total ?? 0);
    var lastPage = Math.Max(1, (int)Math.Ceiling(total / (double)pageSize));
}

<h1>Mensajes de contacto</h1>

<form method="get" class="mb-3">
  <div class="row g-2">
    <div class="col-sm-4">
      <input name="buscar" value="@buscar" class="form-control" placeholder="Buscar por nombre, correo o texto" />
    </div>
    <div class="col-sm-3">
      <select name="estado" class="form-select">
        <option value="" selected="@string.IsNullOrEmpty(estado)">Todos</option>
        <option value="pendiente" selected="@(estado=="pendiente")">Pendiente</option>
        <option value="visto" selected="@(estado=="visto")">Visto</option>
        <option value="completado" selected="@(estado=="completado")">Completado</option>
      </select>
    </div>
    <div class="col-sm-2">
      <select name="pageSize" class="form-select">
        <option value="10" selected="@(pageSize==10)">10</option>
        <option value="20" selected="@(pageSize==20)">20</option>
        <option value="50" selected="@(pageSize==50)">50</option>
      </select>
    </div>
    <div class="col-sm-2">
      <button class="btn btn-primary w-100" type="submit">Filtrar</button>
    </div>
  </div>
</form>

<table class="table table-striped table-sm align-middle">
  <thead>
    <tr>
      <th>Id</th>
      <th>Fecha</th>
      <th>Nombre</th>
      <th>Correo</th>
      <th>Mensaje</th>
      <th>Visto</th>
      <th>Completado</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
@foreach (var x in Model)
{
    <tr>
      <td>@x.Id</td>
      <td>@x.FechaEnvio.ToString("yyyy-MM-dd HH:mm")</td>
      <td>@x.Nombre</td>
      <td>@x.Correo</td>
      <td>@(x.Mensaje?.Length > 80 ? x.Mensaje.Substring(0,80) + "..." : x.Mensaje)</td>
      <td>@(x.Visto ? "Sí" : "No")</td>
      <td>@(x.Completado ? "Sí" : "No")</td>
      <td class="text-nowrap">
        <form asp-action="MarcarVisto" method="post" class="d-inline">
          @Html.AntiForgeryToken()
          <input type="hidden" name="id" value="@x.Id" />
          <input type="hidden" name="visto" value="@x.Visto" />
          <input type="hidden" name="completado" value="@x.Completado" />
          <input type="hidden" name="returnUrl" value="@($"{ViewContext.HttpContext.Request.Path}{ViewContext.HttpContext.Request.QueryString}")" />
          <button class="btn btn-outline-secondary btn-sm" @(x.Visto ? "disabled" : "")>Marcar visto</button>
        </form>
        <form asp-action="MarcarCompletado" method="post" class="d-inline">
          @Html.AntiForgeryToken()
          <input type="hidden" name="id" value="@x.Id" />
          <input type="hidden" name="visto" value="@x.Visto" />
          <input type="hidden" name="completado" value="@x.Completado" />
          <input type="hidden" name="returnUrl" value="@($"{ViewContext.HttpContext.Request.Path}{ViewContext.HttpContext.Request.QueryString}")" />
          <button class="btn btn-success btn-sm" @(x.Completado ? "disabled" : "")>Completar</button>
        </form>
      </td>
    </tr>
}
  </tbody>
</table>

@{
    var prev = Math.Max(1, page - 1);
    var next = Math.Min(lastPage, page + 1);
}

<nav aria-label="Paginación" class="mt-3">
  <ul class="pagination">
    <li class="page-item @(page<=1 ? "disabled":"")">
      <a class="page-link" href="@Url.Action("Index", new { buscar, estado, page = 1, pageSize })">Primera</a>
    </li>
    <li class="page-item @(page<=1 ? "disabled":"")">
      <a class="page-link" href="@Url.Action("Index", new { buscar, estado, page = prev, pageSize })">Anterior</a>
    </li>
        <li class="page-item disabled">
            <span class="page-link">Página @(page) de @lastPage</span>
        </li>

      <a class="page-link" href="@Url.Action("Index", new { buscar, estado, page = next, pageSize })">Siguiente</a>
    </li>
    <li class="page-item @(page>=lastPage ? "disabled":"")">
      <a class="page-link" href="@Url.Action("Index", new { buscar, estado, page = lastPage, pageSize })">Última</a>
    </li>
  </ul>
</nav>
